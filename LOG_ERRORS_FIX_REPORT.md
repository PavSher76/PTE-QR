# üîß –û–¢–ß–ï–¢ –û–ë –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò –û–®–ò–ë–û–ö –í –õ–û–ì–ê–•

## üìä –ê–ù–ê–õ–ò–ó –û–®–ò–ë–û–ö

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤:

1. **`'PdfReader' object has no attribute 'close'`**
   - **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/utils/pdf_analyzer.py:1492`
   - **–ü—Ä–∏—á–∏–Ω–∞**: PyPDF2 PdfReader –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ `close()`
   - **–í–ª–∏—è–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ PDF

2. **`'pdf_path' is not defined`**
   - **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/utils/pdf_analyzer.py:868, 1808`
   - **–ü—Ä–∏—á–∏–Ω–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `pdf_path` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–π `pdf_content`
   - **–í–ª–∏—è–Ω–∏–µ**: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `detect_qr_position_in_stamp_region`

3. **`'cannot access local variable 'x0' where it is not associated with a value`**
   - **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/services/pdf_service.py:799`
   - **–ü—Ä–∏—á–∏–Ω–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `x0` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ `except` –±–µ–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
   - **–í–ª–∏—è–Ω–∏–µ**: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —è–∫–æ—Ä—è QR –∫–æ–¥–∞

4. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤**
   - **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: AuthService, QRService, PDFService
   - **–ü—Ä–∏—á–∏–Ω–∞**: –°–µ—Ä–≤–∏—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - **–í–ª–∏—è–Ω–∏–µ**: –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ PdfReader.close()**

**–§–∞–π–ª**: `backend/app/utils/pdf_analyzer.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
doc.close()  # ‚ùå PdfReader –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ close()
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
# PdfReader –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ close()
# –î–æ–∫—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞

### **2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 'pdf_path' is not defined**

**–§–∞–π–ª**: `backend/app/utils/pdf_analyzer.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ detect_qr_position_in_stamp_region(pdf_content: bytes, ...)
position = self.detect_qr_position_in_stamp_region(pdf_path, page_number)  # ‚ùå pdf_path –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
import tempfile
with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as temp_file:
    temp_file.write(pdf_content)
    temp_pdf_path = temp_file.name

try:
    position = self.detect_qr_position_in_stamp_region(temp_pdf_path, page_number)
finally:
    os.unlink(temp_pdf_path)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

### **3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 'cannot access local variable 'x0'**

**–§–∞–π–ª**: `backend/app/services/pdf_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
except Exception as e:
    debug_logger.error("‚ùå Error computing anchor", error=str(e), rotation=rotation)
    x = max(x0, min(x1 - margin_pt - qr_w, x1 - qr_w))  # ‚ùå x0 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
    y = max(y0, min(y0 + margin_pt + stamp_clearance_pt, y1 - qr_h))
    return x, y
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
except Exception as e:
    debug_logger.error("‚ùå Error computing anchor", error=str(e), rotation=rotation)
    # Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    x = max(0.0, min(100.0 - margin_pt - qr_w, 100.0 - qr_w))
    y = max(0.0, min(0.0 + margin_pt + stamp_clearance_pt, 100.0 - qr_h))
    return x, y
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ –Ω–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

### **4. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤**

**–§–∞–π–ª—ã**: 
- `backend/app/services/auth_service.py`
- `backend/app/services/qr_service.py`
- `backend/app/services/pdf_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
class AuthService:
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
        # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
```

**–†–µ—à–µ–Ω–∏–µ** - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Singleton –ø–∞—Ç—Ç–µ—Ä–Ω–∞:
```python
class AuthService:
    _instance = None
    _initialized = False

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(AuthService, cls).__new__(cls)
        return cls._instance

    def __init__(self):
        if self._initialized:
            return
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        self._initialized = True
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –æ—á–∏—â–µ–Ω—ã –ª–æ–≥–∏

## üìà –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**:
```
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [debug    ] Function call                  function=AuthService.__init__ parameters={}
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [debug    ] Function call                  function=AuthService.__init__ parameters={}
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [info     ] AuthService initialized        algorithm=HS256 token_expire_minutes=480
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [debug    ] Function call                  function=AuthService.__init__ parameters={}
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [info     ] AuthService initialized        algorithm=HS256 token_expire_minutes=480
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [info     ] AuthService initialized        algorithm=HS256 token_expire_minutes=480
```

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**:
```
2025-09-28 22:25:28.165 | 2025-09-28 19:25:28 [info     ] AuthService initialized        algorithm=HS256 token_expire_minutes=480
2025-09-28 22:25:28.205 | 2025-09-28 19:25:28 [info     ] QRService initialized          error_correction=M qr_border=4 qr_size=200
2025-09-28 22:25:28.536 | 2025-09-28 19:25:28 [info     ] PDFService initialized         output_dir=/tmp/pte_qr_pdf_output
```

### **–£—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏**:
```
‚ùå 'PdfReader' object has no attribute 'close'
‚ùå 'pdf_path' is not defined  
‚ùå 'cannot access local variable 'x0' where it is not associated with a value'
‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
```

### **–£–ª—É—á—à–µ–Ω–∏—è**:
- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ PDF
- ‚úÖ **–û—á–∏—â–µ–Ω—ã –ª–æ–≥–∏** –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ **–ü–æ–≤—ã—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤** —á–µ—Ä–µ–∑ Singleton
- ‚úÖ **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

## üéØ –°–¢–ê–¢–£–° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| –û—à–∏–±–∫–∞ | –°—Ç–∞—Ç—É—Å | –í–ª–∏—è–Ω–∏–µ |
|--------|--------|---------|
| PdfReader.close() | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ |
| pdf_path –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ |
| x0 –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | Fallback –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã |
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | Singleton –ø–∞—Ç—Ç–µ—Ä–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω |

## üèÜ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã runtime –æ—à–∏–±–∫–∏** - —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
2. **–û—á–∏—â–µ–Ω—ã –ª–æ–≥–∏** - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
3. **–ü–æ–≤—ã—à–µ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –¥–æ–±–∞–≤–ª–µ–Ω—ã fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - Singleton –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.
