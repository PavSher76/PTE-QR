# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

## –ü—Ä–æ–±–ª–µ–º–∞
–í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –≤–æ–∑–Ω–∏–∫–∞—Ç—å –æ—à–∏–±–∫–∞:
```
Error processing PDF: cannot access local variable 'x0' where it is not associated with a value
```

## –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
–ü–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã **–≤—Å–µ** –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞, –≥–¥–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `x0`, `y0`, `x1`, `y1` –º–æ–≥–ª–∏ –±—ã—Ç—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:

### 1. –§—É–Ω–∫—Ü–∏—è `_calculate_unified_qr_position` (—Å—Ç—Ä–æ–∫–∞ 340)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `active_box`, –Ω–æ –µ—Å–ª–∏ `active_box` –±—ã–ª –ø—É—Å—Ç—ã–º, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
coordinate_info = layout_info.get("coordinate_info", {})
active_box = coordinate_info.get("active_box", {})
rotation = coordinate_info.get("rotation", 0)

# ‚ùå –ü–†–û–ë–õ–ï–ú–ê: x0 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
x0 = active_box.get("x0", float(page.mediabox[0]))  # left
y0 = active_box.get("y0", float(page.mediabox[1]))  # bottom
x1 = active_box.get("x1", float(page.mediabox[2]))  # right
y1 = active_box.get("y1", float(page.mediabox[3]))  # top
```

### 2. –§—É–Ω–∫—Ü–∏—è `_calculate_qr_position` (—Å—Ç—Ä–æ–∫–∏ 477-480)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
if layout_info:
    coordinate_info = layout_info.get("coordinate_info", {})
    active_box = coordinate_info.get("active_box", {})
    # ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ layout_info —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    x0 = active_box.get("x0", 0.0)
    y0 = active_box.get("y0", 0.0)
    x1 = active_box.get("x1", page_width)
    y1 = active_box.get("y1", page_height)
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `_calculate_unified_qr_position`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
coordinate_info = layout_info.get("coordinate_info", {})
active_box = coordinate_info.get("active_box", {})
rotation = coordinate_info.get("rotation", 0)

# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ MediaBox
x0 = float(page.mediabox[0])  # left
y0 = float(page.mediabox[1])  # bottom
x1 = float(page.mediabox[2])  # right
y1 = float(page.mediabox[3])  # top

# ‚úÖ –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑ active_box, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
if active_box:
    x0 = active_box.get("x0", x0)
    y0 = active_box.get("y0", y0)
    x1 = active_box.get("x1", x1)
    y1 = active_box.get("y1", y1)
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `_calculate_qr_position`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
x0 = 0.0
y0 = 0.0
x1 = page_width
y1 = page_height

# ‚úÖ –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑ layout_info, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
if layout_info:
    coordinate_info = layout_info.get("coordinate_info", {})
    active_box = coordinate_info.get("active_box", {})
    if active_box:
        x0 = active_box.get("x0", x0)
        y0 = active_box.get("y0", y0)
        x1 = active_box.get("x1", x1)
        y1 = active_box.get("y1", y1)
```

## –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø "–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è":
1. **–í—Å–µ–≥–¥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** –ø–µ—Ä–µ–¥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
2. **–ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** –∏–∑ MediaBox –∏–ª–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
3. **–û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è** –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
4. **–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ** –æ–±—ä–µ–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ –∏—Ö –∞—Ç—Ä–∏–±—É—Ç–∞–º

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: `x0 = float(page.mediabox[0])` –∏–ª–∏ `x0 = 0.0`
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: `if active_box:` –∏–ª–∏ `if layout_info:`
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: `x0 = active_box.get("x0", x0)`
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: `_calculate_unified_qr_position`
```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ MediaBox
x0 = float(page.mediabox[0])  # 0.0
y0 = float(page.mediabox[1])  # 0.0
x1 = float(page.mediabox[2])  # 100.0
y1 = float(page.mediabox[3])  # 100.0

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ active_box
active_box = {'x0': 10.0, 'y1': 90.0}
if active_box:
    x0 = active_box.get('x0', x0)  # 10.0
    y0 = active_box.get('y0', y0)  # 0.0 (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    x1 = active_box.get('x1', x1)  # 100.0 (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    y1 = active_box.get('y1', y1)  # 90.0

# –†–µ–∑—É–ª—å—Ç–∞—Ç: x0=10.0, y0=0.0, x1=100.0, y1=90.0
```

### –¢–µ—Å—Ç 2: `_calculate_qr_position`
```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
x0 = 0.0
y0 = 0.0
x1 = page_width  # 100.0
y1 = page_height  # 100.0

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ layout_info
layout_info = {'coordinate_info': {'active_box': {'x0': 5.0, 'y1': 95.0}}}
if layout_info:
    coordinate_info = layout_info.get('coordinate_info', {})
    active_box = coordinate_info.get('active_box', {})
    if active_box:
        x0 = active_box.get('x0', x0)  # 5.0
        y0 = active_box.get('y0', y0)  # 0.0 (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        x1 = active_box.get('x1', x1)  # 100.0 (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        y1 = active_box.get('y1', y1)  # 95.0

# –†–µ–∑—É–ª—å—Ç–∞—Ç: x0=5.0, y0=0.0, x1=100.0, y1=95.0
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ **–û—à–∏–±–∫–∞ `cannot access local variable 'x0' where it is not associated with a value` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**

‚úÖ **–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è `layout_info` –∏ `active_box`

‚úÖ **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã** –ø–µ—Ä–µ–¥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤** —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ `if active_box:` –∏ `if layout_info:`

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫–æ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `backend/app/services/pdf_service.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 2 —Ñ—É–Ω–∫—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω—ã –æ—Ç—á–µ—Ç—ã: `VARIABLE_SCOPE_FIX_REPORT.md`, `FINAL_VARIABLE_SCOPE_FIX_REPORT.md`

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
28 —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞

## –°—Ç–∞—Ç—É—Å
üü¢ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê** - –û—à–∏–±–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
