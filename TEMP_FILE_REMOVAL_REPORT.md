# –û—Ç—á–µ—Ç: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ QR FINAL

## üéØ **–ó–∞–¥–∞—á–∞:**
–ò—Å–∫–ª—é—á–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ `add_qr_codes_to_pdf` –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ QR –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –µ–≥–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç.

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

### **1. –ò—Å–∫–ª—é—á–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –∏—Å—Ö–æ–¥–Ω—ã–º PDF –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
with tempfile.NamedTemporaryFile(suffix='.pdf', delete=False) as temp_file:
    temp_file.write(pdf_content)
    input_pdf_path = temp_file.name

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ —Ñ–∞–π–ª
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size_points, input_pdf_path, page_number - 1
)

# –û—á–∏—Å—Ç–∫–∞ –≤ finally –±–ª–æ–∫–µ
finally:
    if 'input_pdf_path' in locals() and os.path.exists(input_pdf_path):
        os.unlink(input_pdf_path)
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –†–∞–±–æ—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —Å pdf_content
reader = PdfReader(BytesIO(pdf_content))

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–ø—Ä—è–º—É—é —Å pdf_content
x_position, y_position, position_info = self._calculate_unified_qr_position(
    page, qr_size_points, pdf_content, page_number - 1
)

# –ù–∏–∫–∞–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏!
```

### **2. –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `_calculate_unified_qr_position`:**

```python
def _calculate_unified_qr_position(self, page, qr_size: float, pdf_content_or_path, page_number: int) -> tuple[float, float, dict]:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é QR –∫–æ–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    
    Returns:
        Tuple (x, y, info) –≥–¥–µ info —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ª–æ–≥–∞
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞
        x0 = float(page.mediabox.x0)
        y0 = float(page.mediabox.y0)
        x1 = float(page.mediabox.x1)
        y1 = float(page.mediabox.y1)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å bottom-right
        base_x, base_y = self.compute_anchor_xy(
            x0=x0, y0=y0, x1=x1, y1=y1,
            qr_w=qr_size, qr_h=qr_size,
            margin_pt=settings.QR_MARGIN_PT,
            stamp_clearance_pt=settings.QR_STAMP_CLEARANCE_PT,
            rotation=0
        )
        
        # TODO: –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —à—Ç–∞–º–ø–∞ –∏ –¥–µ–ª—å—Ç—É
        dx, dy = 0.0, 0.0  # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–ª—å—Ç—É –∏ –∫–ª—ç–º–ø–∏–º
        x_position = max(x0, min(base_x + dx, x1 - qr_size))
        y_position = max(y0, min(base_y + dy, y1 - qr_size))
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ª–æ–≥–∞
        info = {
            'base': (base_x, base_y),
            'delta': (dx, dy),
            'rotation': 0,
            'stamp_bbox': 'NOT_FOUND'
        }
        
        return x_position, y_position, info
```

### **3. –û–±–Ω–æ–≤–ª–µ–Ω –ª–æ–≥ QR FINAL:**

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–∞ (–∫–∞–∫ –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):**
```python
# QR FINAL: –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π QR –∫–æ–¥–∞
debug_logger.info("üéØ QR FINAL - Position before insertion", 
                page=page_number,
                box=active_box_type,
                rot=position_info.get('rotation', 0),
                x0=x0, y0=y0, x1=x1, y1=y1,
                qr=(qr_size, qr_size),
                margin=settings.QR_MARGIN_PT,
                clearance=settings.QR_STAMP_CLEARANCE_PT,
                stamp_bbox=position_info.get('stamp_bbox', 'NOT_FOUND'),
                base=position_info.get('base', 'UNKNOWN'),
                final=(x_position, y_position))
```

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É:**
```
QR FINAL: page=i, box=media, rot=0, 
x0=...,y0=...,x1=...,y1=..., 
qr=(w=...,h=...), margin=..., clearance=..., 
stamp_bbox=(sx0,sy0,sx1,sy1) FOUND|NOT_FOUND, 
base=(x_anchor,y_anchor), final=(x,y)
```

### **4. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤:**

```python
# –í _add_qr_code_to_page
x_position, y_position, position_info = self._calculate_unified_qr_position(
    page, qr_size, pdf_path, page_number - 1
)

# –í add_qr_codes_to_pdf
x_position, y_position, position_info = self._calculate_unified_qr_position(
    page, qr_size_points, pdf_content, page_number - 1
)
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

### **1. –†–∞–±–æ—Ç–∞ —Å pdf_content –Ω–∞–ø—Ä—è–º—É—é:**
- **‚úÖ –ù–∏–∫–∞–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **‚úÖ –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å BytesIO(pdf_content)**
- **‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### **2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ª–æ–≥–µ:**
- **‚úÖ –ì—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞** (x0, y0, x1, y1)
- **‚úÖ –ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å** –æ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `compute_anchor_xy`
- **‚úÖ –î–µ–ª—å—Ç–∞ –æ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫** (–ø–æ–∫–∞ 0, –Ω–æ –≥–æ—Ç–æ–≤–æ –¥–ª—è —à—Ç–∞–º–ø–∞)
- **‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à—Ç–∞–º–ø–µ** (–ø–æ–∫–∞ NOT_FOUND, –Ω–æ –≥–æ—Ç–æ–≤–æ)

### **3. –ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**
- **‚úÖ `_calculate_unified_qr_position`** –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
- **‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –¥–ª—è –ª–æ–≥–∞
- **‚úÖ –ì–æ—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è** –∞–Ω–∞–ª–∏–∑–æ–º —à—Ç–∞–º–ø–∞

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå –°–æ–∑–¥–∞–≤–∞–ª—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å pdf_content
- ‚ùå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚ùå –ù–µ–ø–æ–ª–Ω—ã–π –ª–æ–≥ –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü –±–æ–∫—Å–∞ –∏ –±–∞–∑–æ–≤–æ–≥–æ —è–∫–æ—Ä—è
- ‚ùå –ú–µ—Ç–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (`_calculate_landscape_qr_position`)

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –†–∞–±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é —Å pdf_content
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ü–æ–ª–Ω—ã–π –ª–æ–≥ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –±–æ–∫—Å–∞ –∏ –±–∞–∑–æ–≤—ã–º —è–∫–æ—Ä–µ–º
- ‚úÖ –ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `_calculate_unified_qr_position`

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

‚úÖ **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏—Å–∫–ª—é—á–µ–Ω—ã** - —Ä–∞–±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é —Å pdf_content
‚úÖ **–õ–æ–≥ QR FINAL –æ–±–Ω–æ–≤–ª–µ–Ω** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚úÖ **–ú–µ—Ç–æ–¥ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω** - –≥–æ—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–º —à—Ç–∞–º–ø–∞
‚úÖ **–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ª–æ–≥–µ** - –≥—Ä–∞–Ω–∏—Ü—ã –±–æ–∫—Å–∞, –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å, –¥–µ–ª—å—Ç–∞, —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ QR –∫–æ–¥–æ–≤! üöÄ

## üöß **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. **üöß –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —à—Ç–∞–º–ø–∞** - –∑–∞–º–µ–Ω–∏—Ç—å `dx, dy = 0.0, 0.0` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
2. **üöß –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `stamp_bbox`** - –Ω–∞–π—Ç–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —à—Ç–∞–º–ø–∞
3. **üöß –ü–æ–ª—É—á–∏—Ç—å rotation** –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
4. **üöß –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–æ–≤–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
