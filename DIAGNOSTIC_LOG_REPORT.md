# –û—Ç—á–µ—Ç: –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

## üéØ **–ó–∞–¥–∞—á–∞:**
"–î–æ–±–∞–≤—å—Ç–µ –≤ pdf_service –æ–¥–∏–Ω DEBUG-–ø—Ä–∏–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ä–∞—Å—á—ë—Ç–æ–≤:
page=i, box=media, W=...,H=..., rot=..., anchor=bottom-right,
qr=(w,h), margin=..., base=(x_a,y_a), delta=(dx,dy), final=(x,y)"

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

### **1. –û–±–Ω–æ–≤–ª–µ–Ω –ª–æ–≥ –≤ `_calculate_unified_qr_position`:**

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```python
debug_logger.info("üîç COORDINATE PIPELINE AUDIT - Detailed calculation", 
                page=page_number,
                box=coordinate_info.get("active_box_type", "media"),
                W=page_width,
                H=page_height,
                rot=rotation,
                anchor=settings.QR_ANCHOR,
                qr=(qr_size, qr_size),
                margin=settings.QR_MARGIN_PT,
                base=(base_x, base_y),      # ‚Üê –ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
                delta=(dx, dy),             # ‚Üê –î–µ–ª—å—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫
                final=(x_position, y_position),  # ‚Üê –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
                respect_rotation=settings.QR_RESPECT_ROTATION)
```

### **2. –û–±–Ω–æ–≤–ª–µ–Ω –ª–æ–≥ –≤ `_calculate_landscape_qr_position`:**

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```python
debug_logger.info("üîç LANDSCAPE - Base anchor + heuristics delta", 
                page=page_number,
                box="media",
                W=page_width,
                H=page_height,
                rot=0,
                anchor=settings.QR_ANCHOR,
                qr=(qr_size, qr_size),
                margin=settings.QR_MARGIN_PT,
                base=(base_x, base_y),      # ‚Üê –ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
                delta=(dx, dy),             # ‚Üê –î–µ–ª—å—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫
                final=(x_position, y_position))  # ‚Üê –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
```

### **3. –û–±–Ω–æ–≤–ª–µ–Ω –ª–æ–≥ –≤ `_add_qr_code_to_page`:**

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```python
debug_logger.info("üîç COORDINATE PIPELINE AUDIT - Before QR insertion", 
                page=page_number,
                box=active_box_type,
                W=page_width,
                H=page_height,
                rotation="TBD",
                qr=(qr_size, qr_size),
                margin="TBD",
                x_position=x_position,
                y_position=y_position,
                x_cm=round(x_position / 28.35, 2),
                y_cm=round(y_position / 28.35, 2))
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

### **1. –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:**
- **page**: –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **box**: —Ç–∏–ø –∫–æ—Ä–æ–±–∫–∏ (media/crop)
- **W, H**: —Ä–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **rot**: –ø–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **anchor**: —è–∫–æ—Ä—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- **qr**: —Ä–∞–∑–º–µ—Ä QR –∫–æ–¥–∞
- **margin**: –æ—Ç—Å—Ç—É–ø
- **base**: –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
- **delta**: –¥–µ–ª—å—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫
- **final**: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è

### **2. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:**
- **base**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å QR –ø–æ —è–∫–æ—Ä—é
- **delta**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø–æ–∑–∏—Ü–∏—é
- **final**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é

### **3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- –ï—Å–ª–∏ `delta=(0,0)` - —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏
- –ï—Å–ª–∏ `delta=(dx,dy)` - —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø–æ–∑–∏—Ü–∏—é
- –ï—Å–ª–∏ `final.y` –±–ª–∏–∑–∫–æ –∫ `base.y` - QR –æ—Å—Ç–∞–ª—Å—è –≤–Ω–∏–∑—É
- –ï—Å–ª–∏ `final.y` —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç `base.y` - –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞

## üìä **–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:**

```
üîç COORDINATE PIPELINE AUDIT - Detailed calculation page=13 box=media W=841.89 H=595.28 rot=0 anchor=bottom-right qr=(99.225, 99.225) margin=12.0 base=(730.665, 12.0) delta=(0.0, 0.0) final=(730.665, 12.0)
```

**–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:**
- **page=13**: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 13
- **box=media**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MediaBox
- **W=841.89, H=595.28**: —Ä–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **rot=0**: –ø–æ–≤–æ—Ä–æ—Ç 0¬∞
- **anchor=bottom-right**: —è–∫–æ—Ä—å –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π
- **qr=(99.225, 99.225)**: —Ä–∞–∑–º–µ—Ä QR –∫–æ–¥–∞
- **margin=12.0**: –æ—Ç—Å—Ç—É–ø 12 pt
- **base=(730.665, 12.0)**: –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å (–Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π)
- **delta=(0.0, 0.0)**: —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏
- **final=(730.665, 12.0)**: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è = –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

‚úÖ **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤** - –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
‚úÖ **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞** - base ‚Üí delta ‚Üí final
‚úÖ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º** - —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –∫—Ç–æ "–ø–æ–¥–Ω—è–ª" QR –≤–≤–µ—Ä—Ö
‚úÖ **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–æ–º** - –ª–µ–≥–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –∫—Ç–æ –∏–º–µ–Ω–Ω–æ "–ø–æ–¥–Ω—è–ª" QR –≤–≤–µ—Ä—Ö! üöÄ
