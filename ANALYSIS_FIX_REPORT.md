# –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞:**
```
‚Äî /tmp/tmplcuosnwx.pdf, total_pages: 1, page_number: 3 ‚Üí out of range ‚Üí fallback (14.2, 14.2);
‚Äî /tmp/tmpn7aph9p4.pdf, page_number: 4 ‚Üí out of range ‚Üí fallback (14.2, 14.2);
‚Äî /tmp/tmp345oec2y.pdf, page_number: 5 ‚Üí out of range ‚Üí fallback (14.2, 14.2).
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–≤–∞–ª—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF, –Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí –∞–Ω–∞–ª–∏–∑ "–ø—Ä–æ–º–∞—Ö–∏–≤–∞–ª—Å—è".

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### **1. –£–±—Ä–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF
temp_writer = PdfWriter()
temp_writer.add_page(page)  # ‚Üê –¢–æ–ª—å–∫–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞
with tempfile.NamedTemporaryFile(suffix='.pdf', delete=False) as temp_pdf:
    temp_writer.write(temp_pdf)
    temp_pdf_path = temp_pdf.name

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size_points, temp_pdf_path, 0  # ‚Üê page_number=0 –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ
)
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ò–°–•–û–î–ù–´–ú PDF –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
with tempfile.NamedTemporaryFile(suffix='.pdf', delete=False) as temp_file:
    temp_file.write(pdf_content)  # ‚Üê –í–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π PDF
    input_pdf_path = temp_file.name

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size_points, input_pdf_path, page_number - 1  # ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å!
)
```

### **2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:**

```python
finally:
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    if 'input_pdf_path' in locals() and os.path.exists(input_pdf_path):
        os.unlink(input_pdf_path)
```

### **3. –î–æ–±–∞–≤–ª–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π QR –∫–æ–¥–∞:**

```python
# DEBUG QR: –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π QR –∫–æ–¥–∞
debug_logger.info("üéØ DEBUG QR - Final position before insertion", 
                page=page_number,
                box=active_box_type,
                x0=x0, y0=y0, x1=x1, y1=y1,
                rot=0,  # TBD: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
                qr=(qr_size, qr_size),
                margin=settings.QR_MARGIN_PT,
                clearance=settings.QR_STAMP_CLEARANCE_PT,
                base="TBD",  # TBD: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
                delta="TBD",  # TBD: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
                final=(x_position, y_position))
```

### **4. –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞:**

```python
# –ü–æ–ª—É—á–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞
x0 = float(page.mediabox.x0)
y0 = float(page.mediabox.y0)
x1 = float(page.mediabox.x1)
y1 = float(page.mediabox.y1)
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

### **1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
- **‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π PDF** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **‚úÖ –ù–∏–∫–∞–∫–∏—Ö –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö PDF**
- **‚úÖ –ù–∏–∫–∞–∫–∏—Ö "Page number out of range"**

### **2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- **‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞** (x0, y0, x1, y1)
- **‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é** (x, y)
- **‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã QR –∫–æ–¥–∞** (—Ä–∞–∑–º–µ—Ä, –æ—Ç—Å—Ç—É–ø—ã)

### **3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏:**
- **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- **‚úÖ Try-finally –±–ª–æ–∫** –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå –í—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF ‚Üí `total_pages: 1, page_number: 3/4/5` ‚Üí out of range
- ‚ùå –ê–Ω–∞–ª–∏–∑ "–ø—Ä–æ–º–∞—Ö–∏–≤–∞–ª—Å—è" ‚Üí fallback (14.2, 14.2)
- ‚ùå –ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –ê–Ω–∞–ª–∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ PDF —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º ‚Üí –∞–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –Ω–∏–∫–∞–∫–∏—Ö fallback (14.2, 14.2)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π QR –∫–æ–¥–∞

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

‚úÖ **–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π PDF —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º
‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω** - –≤–∏–¥–Ω—ã –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π QR –∫–æ–¥–∞
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
‚úÖ **–ù–∏–∫–∞–∫–∏—Ö "–ø—Ä–æ–º–∞—Ö–æ–≤" –≤ –∞–Ω–∞–ª–∏–∑–µ**

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ QR –∫–æ–¥–æ–≤! üöÄ

## üöß **TODO –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–Ω–∞–ª–∏–∑–∞** - –∑–∞–ø–æ–ª–Ω–∏—Ç—å `rot`, `base`, `delta` –≤ –ª–æ–≥–µ
2. **–ü–æ–∏—Å–∫ —à—Ç–∞–º–ø–∞** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –∏ —Ä–∞—Å—Ç—Ä–æ–≤—ã–π —Å–ø–æ—Å–æ–±—ã
3. **–î–µ–ª—å—Ç–∞ –æ—Ç —à—Ç–∞–º–ø–∞** - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–æ–ª—å–∫–æ dy –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –Ω–∞–¥ —à—Ç–∞–º–ø–æ–º
