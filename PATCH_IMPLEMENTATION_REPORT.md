# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ç—á–∞ —Å–∏—Å—Ç–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **app/utils/pdf_analyzer.py** - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

#### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
```python
def to_pdf_point(x_img: float, y_img: float, page_h: float) -> tuple[float, float]:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–æ—á–∫—É –∏–∑ image-–°–ö –≤ PDF-–°–ö"""
    x_pdf = x_img
    y_pdf = page_h - y_img  # –î–ª—è —Ç–æ—á–∫–∏
    return x_pdf, y_pdf

def to_pdf_bbox(x_img: float, y_img: float, obj_w: float, obj_h: float, page_h: float):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç bbox –∏–∑ image-–°–ö –≤ PDF-–°–ö"""
    x_pdf = x_img
    y_pdf = page_h - (y_img + obj_h)  # –î–ª—è bbox (–≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª)
    return x_pdf, y_pdf, obj_w, obj_h
```

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —ç–≤—Ä–∏—Å—Ç–∏–∫:
```python
def compute_heuristics_delta(self, pdf_path: str, page_number: int = 0) -> tuple[float, float]:
    """–í—ã—á–∏—Å–ª—è–µ—Ç –¥–µ–ª—å—Ç—É (dx, dy) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —è–∫–æ—Ä—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–≤—Ä–∏—Å—Ç–∏–∫"""
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–ª—å—Ç—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –±–∞–∑–æ–≤–æ–≥–æ —è–∫–æ—Ä—è
    # x_final = x_anchor + dx, y_final = y_anchor + dy
```

### 2. **app/services/pdf_service.py** - –†–∞—Å—á—ë—Ç —è–∫–æ—Ä—è

#### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
```python
def compute_anchor_xy(self, W: float, H: float, qr_w: float, qr_h: float, 
                     margin: float, rotation: int, anchor: str = "bottom-right") -> tuple[float, float]:
    """–í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è–∫–æ—Ä—è —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ –¥–ª—è bottom-right —è–∫–æ—Ä—è:
    if rotation == 0:
        x = W - margin - qr_w
        y = margin
    elif rotation == 90:
        x = margin
        y = margin
    elif rotation == 180:
        x = margin
        y = H - margin - qr_h
    elif rotation == 270:
        x = W - margin - qr_w
        y = H - margin - qr_h
    
    # –ö–ª—ç–º–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    x = max(0, min(x, W - qr_w))
    y = max(0, min(y, H - qr_h))
    
    return x, y
```

### 3. **config/settings** - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `backend/app/core/config.py`:
```python
QR_ANCHOR: str = "bottom-right"
QR_MARGIN_PT: float = 12.0
QR_POSITION_BOX: str = "media"
QR_RESPECT_ROTATION: bool = True
QR_SUPPORT_PORTRAIT: bool = False
```

### 4. **tests/test_qr_positioning.py** - –†–µ–≥—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã

#### –ù–æ–≤—ã–π –∫–ª–∞—Å—Å —Ç–µ—Å—Ç–æ–≤:
```python
class TestQRPositioningRotations:
    """–¢–µ—Å—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–æ–≤ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏"""
    
    def test_rotation_0_degrees(self, pdf_service):
        """–¢–µ—Å—Ç: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ 0¬∞"""
        
    def test_rotation_90_degrees(self, pdf_service):
        """–¢–µ—Å—Ç: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ 90¬∞"""
        
    def test_rotation_180_degrees(self, pdf_service):
        """–¢–µ—Å—Ç: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ 180¬∞"""
        
    def test_rotation_270_degrees(self, pdf_service):
        """–¢–µ—Å—Ç: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ 270¬∞"""
        
    def test_coordinate_clamping(self, pdf_service):
        """–¢–µ—Å—Ç: –∫–ª—ç–º–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
        
    def test_heuristics_delta_calculation(self, pdf_analyzer, tmp_path):
        """–¢–µ—Å—Ç: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–µ–ª—å—Ç—ã —ç–≤—Ä–∏—Å—Ç–∏–∫"""
```

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ —ç–≤—Ä–∏—Å—Ç–∏–∫

### –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥:
1. **–ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å**: –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∂—ë—Å—Ç–∫–æ –ø–æ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
2. **–≠–≤—Ä–∏—Å—Ç–∏–∫–∏**: –í–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–µ–ª—å—Ç—É `(dx, dy)` –¥–ª—è –º–µ–ª–∫–∏—Ö –∫–æ—Ä—Ä–µ–∫—Ü–∏–π
3. **–§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è**: `x_final = x_anchor + dx, y_final = y_anchor + dy`
4. **–ö–ª—ç–º–ø**: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç—Å—è –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
5. **–ù–∏–∫–∞–∫–æ–≥–æ "–ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–Ω–∏—è"**: –ü—Ä–∏ `anchor=bottom-right` QR –Ω–µ "–ø—Ä—ã–≥–∞–µ—Ç" –Ω–∞ –≤–µ—Ä—Ö

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
# 1. –í—ã—á–∏—Å–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
base_x, base_y = pdf_service.compute_anchor_xy(W, H, qr_w, qr_h, margin, rotation, anchor)

# 2. –ü–æ–ª—É—á–∞–µ–º –¥–µ–ª—å—Ç—É –æ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫
dx, dy = pdf_analyzer.compute_heuristics_delta(pdf_path, page_number)

# 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ü–∏—é
final_x = base_x + dx
final_y = base_y + dy

# 4. –ö–ª—ç–º–ø–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
final_x = max(0, min(final_x, W - qr_w))
final_y = max(0, min(final_y, H - qr_h))
```

## –¢–∞–±–ª–∏—Ü–∞ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤

| –ü–æ–≤–æ—Ä–æ—Ç | X | Y | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|---|---|----------|
| 0¬∞ | `W - margin - qr_w` | `margin` | –ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª |
| 90¬∞ | `margin` | `margin` | –í–∏–∑—É–∞–ª—å–Ω—ã–π –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π |
| 180¬∞ | `margin` | `H - margin - qr_h` | –í–∏–∑—É–∞–ª—å–Ω—ã–π –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π |
| 270¬∞ | `W - margin - qr_w` | `H - margin - qr_h` | –í–∏–∑—É–∞–ª—å–Ω—ã–π –Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π |

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
1. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è —Ç–æ—á–∫–∏ –∏ bbox
2. **–ñ—ë—Å—Ç–∫–∏–π —è–∫–æ—Ä—å**: –ë–∞–∑–æ–≤–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —ç–≤—Ä–∏—Å—Ç–∏–∫
3. **–ü–æ–≤–æ—Ä–æ—Ç—ã**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —É–≥–ª–æ–≤ –ø–æ–≤–æ—Ä–æ—Ç–∞
4. **–ö–ª—ç–º–ø –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**: –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
5. **–≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞–∫ –¥–µ–ª—å—Ç–∞**: –ú–µ–ª–∫–∏–µ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –∑–∞–º–µ–Ω—ã —è–∫–æ—Ä—è
6. **–†–µ–≥—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã**: –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤

### üéØ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**
- –°–∏—Å—Ç–µ–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü–æ–≤–æ—Ä–æ—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –Ω–µ "–ª–æ–º–∞—é—Ç" –±–∞–∑–æ–≤–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
python -m pytest backend/tests/test_qr_positioning.py -v

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
python -m pytest backend/tests/test_qr_positioning.py::TestQRPositioningRotations -v
```

–ü–∞—Ç—á –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ
