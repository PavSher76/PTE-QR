# –û—Ç—á–µ—Ç: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## üéØ **–ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–¥ –±—ç–∫–µ–Ω–¥–∞ –ù–ï —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ QR –∫–æ–¥–∞.

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:**

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ tempfile:**
```bash
grep -rn "tempfile\|NamedTemporaryFile" backend/
# –†–µ–∑—É–ª—å—Ç–∞—Ç: No matches found ‚úÖ
```

### **2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤:**
```bash
grep -rn "\.write\|\.save\|open.*w" backend/app/services/pdf_service.py
# –†–µ–∑—É–ª—å—Ç–∞—Ç: No matches found ‚úÖ

grep -rn "\.write\|\.save\|open.*w" backend/app/utils/pdf_analyzer.py  
# –†–µ–∑—É–ª—å—Ç–∞—Ç: No matches found ‚úÖ
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–∞ `add_qr_codes_to_pdf`:**

**‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å BytesIO –Ω–∞–ø—Ä—è–º—É—é:**
```python
def add_qr_codes_to_pdf(self, pdf_content: bytes, ...):
    try:
        logger.debug("Adding QR codes to PDF", ...)
        reader = PdfReader(BytesIO(pdf_content))  # ‚Üê –ù–∏–∫–∞–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤!
        writer = PdfWriter()
        qr_codes_data_list = []

        for i, page in enumerate(reader.pages):
            page_number = i + 1
            # ... –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```

### **4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–∞ `_calculate_unified_qr_position`:**

**‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç pdf_content –Ω–∞–ø—Ä—è–º—É—é:**
```python
def _calculate_unified_qr_position(self, page, qr_size: float, pdf_content_or_path, page_number: int):
    """
    Args:
        pdf_content_or_path: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ PDF –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞
        x0 = float(page.mediabox.x0)  # ‚Üê –†–∞–±–æ—Ç–∞–µ–º —Å –æ–±—ä–µ–∫—Ç–æ–º page –Ω–∞–ø—Ä—è–º—É—é
        y0 = float(page.mediabox.y0)
        x1 = float(page.mediabox.x1)
        y1 = float(page.mediabox.y1)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å bottom-right
        base_x, base_y = self.compute_anchor_xy(...)
        
        # TODO: –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —à—Ç–∞–º–ø–∞ –∏ –¥–µ–ª—å—Ç—É
        dx, dy = 0.0, 0.0  # ‚Üê –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å (–ë–ï–ó –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤!)
```

### **5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:**

**‚úÖ –í `add_qr_codes_to_pdf` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è pdf_content:**
```python
x_position, y_position, position_info = self._calculate_unified_qr_position(
    page, qr_size_points, pdf_content, page_number - 1  # ‚Üê pdf_content, –Ω–µ —Ñ–∞–π–ª!
)
```

**‚ö†Ô∏è –í `_add_qr_code_to_page` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è pdf_path (–º–æ–∂–µ—Ç –±—ã—Ç—å None):**
```python
x_position, y_position, position_info = self._calculate_unified_qr_position(
    page, qr_size, pdf_path, page_number - 1  # ‚Üê pdf_path (–Ω–æ –∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω)
)
```

### **6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Å–∞ PDFAnalyzer:**

**‚úÖ –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤:**
```python
class PDFAnalyzer:
    """PDF analyzer for detecting stamp and frame positions"""
    
    def __init__(self):
        self.logger = structlog.get_logger(__name__)
    
    # –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ –ø–∞–º—è—Ç–∏, –ù–ï —Å–æ–∑–¥–∞—é—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã:**

### **‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ QR –ø–æ–∑–∏—Ü–∏–π:**

1. **‚úÖ –ù–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ tempfile** –≤ backend –∫–æ–¥–µ
2. **‚úÖ –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤** (write/save)
3. **‚úÖ BytesIO –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PDF –≤ –ø–∞–º—è—Ç–∏
4. **‚úÖ –ê–Ω–∞–ª–∏–∑ —à—Ç–∞–º–ø–∞ –æ—Ç–∫–ª—é—á–µ–Ω** (dx, dy = 0.0, 0.0)
5. **‚úÖ PDFAnalyzer –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã**

### **üîç –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã:**

```python
# 1. PDF –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å
reader = PdfReader(BytesIO(pdf_content))

# 2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –æ–±—ä–µ–∫—Ç–µ page
x0 = float(page.mediabox.x0)  # –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–π—Å—Ç–≤–∞–º

# 3. –ü–æ–∑–∏—Ü–∏—è –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏
base_x, base_y = self.compute_anchor_xy(x0, y0, x1, y1, ...)

# 4. –ù–∏–∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è!
```

## üìä **–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏:**

### **‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–†–û–ô–î–ï–ù–ê:**
- ‚ùå **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è**
- ‚úÖ **–†–∞–±–æ—Ç–∞ —Å PDF –≤ –ø–∞–º—è—Ç–∏**
- ‚úÖ **–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤**
- ‚úÖ **–ù–∏–∫–∞–∫–∏—Ö I/O –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏**

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

**‚úÖ –ö–û–î –ë–≠–ö–ï–ù–î–ê –ß–ò–°–¢–´–ô!**

–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ QR –∫–æ–¥–∞ **–ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è**. –í—Å—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø–∞–º—è—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- `BytesIO(pdf_content)` –¥–ª—è —á—Ç–µ–Ω–∏—è PDF
- `page.mediabox` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü
- –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë–∞–∑–æ–≤–æ–≥–æ —è–∫–æ—Ä—è –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ —à—Ç–∞–º–ø–∞

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏! üöÄ

