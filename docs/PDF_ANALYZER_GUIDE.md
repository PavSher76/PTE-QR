# Руководство по анализу PDF и интеллектуальному позиционированию QR-кодов

## Обзор

Система PTE-QR теперь включает в себя интеллектуальные функции для анализа PDF документов и автоматического определения оптимальных позиций для размещения QR-кодов. Это особенно важно для landscape страниц, где QR-коды должны размещаться относительно штампа основной надписи и рамки чертежа.

## Новые компоненты

### 1. PDFAnalyzer (`backend/app/utils/pdf_analyzer.py`)

Основной класс для анализа PDF документов и определения позиций элементов.

#### Основные методы:

- `detect_stamp_top_edge_landscape()` - Определяет верхний край штампа основной надписи на landscape страницах
- `detect_right_frame_edge()` - Определяет край рамки на правой стороне листа
- `analyze_page_layout()` - Комплексный анализ макета страницы

### 2. Обновленный PDFService

Интегрирован с PDFAnalyzer для использования интеллектуального позиционирования QR-кодов.

#### Новые методы:

- `_calculate_landscape_qr_position()` - Вычисляет оптимальную позицию QR-кода для landscape страниц

## Алгоритм детекции

### Детекция штампа основной надписи

1. **Конвертация страницы в изображение** с высоким разрешением (2x)
2. **Анализ нижней области** страницы (нижние 30%)
3. **Детекция краев** с помощью алгоритма Canny
4. **Поиск контуров** и фильтрация по размеру и форме
5. **Выбор прямоугольных областей** с разумным соотношением сторон
6. **Определение верхнего края** самого большого подходящего контура

### Детекция правого края рамки

1. **Анализ правой области** страницы (правые 20%)
2. **Детекция вертикальных линий** с помощью морфологических операций
3. **Фильтрация по длине** (линии должны быть не менее 30% высоты страницы)
4. **Определение самой правой** вертикальной линии

## Логика позиционирования QR-кодов

### Для Landscape страниц:

**Приоритет позиционирования:**
1. **Y-позиция (ПРИОРИТЕТ)**: Над основной надписью (штампом)
   - Если обнаружен штамп: позиционируется выше штампа с отступом 0.5 см
   - Если только рамки найдены: позиционируется на 4 см от нижней рамки
   - Иначе: используется дефолтная позиция (9 см от низа)

2. **X-позиция (ВТОРОСТЕПЕННО)**: Левее рамки чертежа
   - Если только рамки найдены: позиционируется на 4 см левее правой рамки
   - Если обнаружена правая рамка: позиционируется слева от рамки с отступом 1 см
   - Иначе: используется дефолтная позиция (4 см от левого края)

3. **Проверка границ**: QR-код не должен выходить за пределы страницы

**Логика:**
- Сначала определяем Y (над штампом или от нижней рамки) - это главное требование
- Затем определяем X (левее рамки) - это дополнительное требование
- Если что-то не найдено, используем дефолтные значения

**Специальный случай "Только рамка":**
- Условие: штамп не найден, но найдены правая и нижняя рамки
- Y: 4 см от нижней рамки
- X: 4 см левее правой рамки

### Для Portrait страниц:

Используется существующая логика позиционирования в правом верхнем углу над основной надписью.

## Зависимости

Для работы новых функций требуются следующие библиотеки:

```txt
PyMuPDF==1.23.8
opencv-python==4.8.1.78
scikit-image==0.22.0
scipy==1.11.4
numpy==1.24.4
```

## Использование

### Базовое использование PDFAnalyzer:

```python
from app.utils.pdf_analyzer import PDFAnalyzer

analyzer = PDFAnalyzer()

# Анализ макета страницы
layout_info = analyzer.analyze_page_layout("path/to/document.pdf", page_number=0)

print(f"Ориентация: {'Landscape' if layout_info['is_landscape'] else 'Portrait'}")
print(f"Верхний край штампа: {layout_info['stamp_top_edge']}")
print(f"Правый край рамки: {layout_info['right_frame_edge']}")
```

### Использование в PDFService:

```python
from app.services.pdf_service import PDFService

pdf_service = PDFService()

# Обработка PDF с интеллектуальным позиционированием
result = await pdf_service.process_pdf_with_qr_codes(
    pdf_path="path/to/document.pdf",
    enovia_id="DOC-001",
    title="Test Document",
    revision="A",
    created_by=user_id,
    qr_service=qr_service,
    document_service=document_service
)
```

## Тестирование

### Простой тест логики:

```bash
python test_simple_analyzer.py
```

### Полный тест с реальными PDF:

```bash
python test_pdf_analyzer.py
```

## Примеры результатов

### Случай 1: Штамп и рамка обнаружены
- **Y позиция**: 4.0 см от низа (над штампом с отступом 0.5 см)
- **X позиция**: 22.0 см от левого края (левее рамки с отступом 1 см)
- **Результат**: QR-код размещен над основной надписью, левее рамки чертежа

### Случай 2: Только штамп обнаружен
- **Y позиция**: 4.7 см от низа (над штампом с отступом 0.5 см)
- **X позиция**: 4.0 см от левого края (по умолчанию, рамка не найдена)
- **Результат**: QR-код размещен над основной надписью, X позиция по умолчанию

### Случай 3: Только рамка обнаружена
- **Y позиция**: 5.8 см от низа (4 см от нижней рамки)
- **X позиция**: 19.0 см от левого края (4 см левее правой рамки)
- **Результат**: QR-код размещен по специальной логике "только рамка"

### Случай 4: Ничего не обнаружено
- **Y позиция**: 9.0 см от низа (по умолчанию)
- **X позиция**: 4.0 см от левого края (по умолчанию)
- **Результат**: QR-код размещен в дефолтной позиции

## Обработка ошибок

Система включает многоуровневую обработку ошибок:

1. **Уровень детекции**: Если детекция не удалась, возвращается `None`
2. **Уровень позиционирования**: Если детекция не удалась, используются дефолтные позиции
3. **Уровень границ**: Проверяется, что QR-код не выходит за пределы страницы
4. **Уровень сервиса**: В случае ошибки возвращается оригинальная страница

## Логирование

Все операции детально логируются с использованием structlog:

- Информация о процессе детекции
- Результаты анализа
- Позиции элементов
- Ошибки и предупреждения

## Производительность

- Анализ одной страницы занимает ~1-3 секунды
- Используется кэширование результатов анализа
- Оптимизированные алгоритмы компьютерного зрения

## Ограничения

1. **Качество PDF**: Детекция работает лучше с PDF высокого качества
2. **Стандартные форматы**: Оптимизировано для стандартных форматов чертежей
3. **Разрешение**: Требуется достаточное разрешение для детекции элементов
4. **Зависимости**: Требует установки дополнительных библиотек

## Будущие улучшения

1. **Машинное обучение**: Интеграция ML моделей для более точной детекции
2. **Кэширование**: Кэширование результатов анализа для повторного использования
3. **Пакетная обработка**: Оптимизация для обработки множества документов
4. **Настройка параметров**: Возможность настройки параметров детекции
