# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

## –ü—Ä–æ–±–ª–µ–º–∞
–í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –≤–æ–∑–Ω–∏–∫–∞—Ç—å –æ—à–∏–±–∫–∞:
```
Error processing PDF: cannot access local variable 'x0' where it is not associated with a value
```

## –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
–ü–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã **–≤—Å–µ** –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞:

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞**: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã **–¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º** `_calculate_unified_qr_position`:
- **–ü–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è** (—Å—Ç—Ä–æ–∫–∞ 279): `(page, qr_size: float, pdf_path: str, page_number: int) -> tuple[float, float]`
- **–í—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è** (—Å—Ç—Ä–æ–∫–∞ 799): `(page, qr_size: float, pdf_content: bytes, page_number: int) -> tuple[float, float, dict]`

–í—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∞ –ø–µ—Ä–≤—É—é, —á—Ç–æ –º–æ–≥–ª–æ –≤—ã–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±–ª–∞—Å—Ç—å—é –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤ –±–ª–æ–∫–µ try-except
**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ñ—É–Ω–∫—Ü–∏–∏ `_calculate_unified_qr_position` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `base_x` –∏ `base_y` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤ –±–ª–æ–∫–µ try, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –≤–Ω–µ –±–ª–æ–∫–∞ try-except.

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
try:
    # ... –∫–æ–¥ ...
    base_x, base_y = self.compute_anchor_xy(...)  # ‚ùå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ try
    # ... –∫–æ–¥ ...
except Exception as e:
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è ...
    # base_x –∏ base_y –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–¥–µ—Å—å

# ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–Ω–µ –±–ª–æ–∫–∞ try-except
x_position = base_x + dx  # base_x –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
y_position = base_y + dy  # base_y –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
**–§–∞–π–ª**: `backend/app/services/pdf_service.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
def _calculate_unified_qr_position(self, page, qr_size: float, pdf_path: str, page_number: int) -> tuple[float, float]:

# –°—Ç–∞–ª–æ:
def _calculate_unified_qr_position_legacy(self, page, qr_size: float, pdf_path: str, page_number: int) -> tuple[float, float]:
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å—Ç—Ä–∞–Ω–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω —Ñ—É–Ω–∫—Ü–∏–π. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_calculate_unified_qr_position` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
layout_info = None
rotation = 0
stamp_top_edge = None
dx, dy = 0.0, 0.0

try:
    # ... –∫–æ–¥ ...
    base_x, base_y = self.compute_anchor_xy(...)  # ‚ùå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ try
    # ... –∫–æ–¥ ...
except Exception as e:
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è ...

# ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–Ω–µ –±–ª–æ–∫–∞ try-except
x_position = base_x + dx
y_position = base_y + dy
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```python
layout_info = None
rotation = 0
stamp_top_edge = None
dx, dy = 0.0, 0.0

# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è base_x –∏ base_y –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
base_x, base_y = self.compute_anchor_xy(
    x0=x0, y0=y0, x1=x1, y1=y1,
    qr_w=qr_size,
    qr_h=qr_size,
    margin_pt=settings.QR_MARGIN_PT,
    stamp_clearance_pt=settings.QR_STAMP_CLEARANCE_PT,
    rotation=0
)

try:
    # ... –∫–æ–¥ ...
    # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ base_x –∏ base_y —Å —É—á–µ—Ç–æ–º rotation
    base_x, base_y = self.compute_anchor_xy(
        x0=x0, y0=y0, x1=x1, y1=y1,
        qr_w=qr_size,
        qr_h=qr_size,
        margin_pt=settings.QR_MARGIN_PT,
        stamp_clearance_pt=settings.QR_STAMP_CLEARANCE_PT,
        rotation=rotation
    )
    # ... –∫–æ–¥ ...
except Exception as e:
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è ...
    # base_x –∏ base_y –æ—Å—Ç–∞—é—Ç—Å—è —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

# ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–Ω–µ –±–ª–æ–∫–∞ try-except
x_position = base_x + dx  # base_x –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
y_position = base_y + dy  # base_y –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
```

## –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø "–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è":
1. **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è** –ø–µ—Ä–µ–¥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
2. **–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±–ª–æ–∫–µ try, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω–µ –±–ª–æ–∫–∞ try-except

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: `x0 = float(page.mediabox[0])`, `base_x, base_y = compute_anchor_xy(...)`
2. **–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –í –±–ª–æ–∫–µ try –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**: –í –±–ª–æ–∫–µ except –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç:
```python
def test_comprehensive_fix():
    # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    x0, y0, x1, y1 = 0.0, 0.0, 100.0, 100.0
    
    # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è base_x –∏ base_y –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    base_x, base_y = 50.0, 50.0
    
    # 3. –ò–º–∏—Ç–∞—Ü–∏—è –±–ª–æ–∫–∞ try-except
    try:
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        active_box = {'x0': 10.0, 'y1': 90.0}
        if active_box:
            x0 = active_box.get('x0', x0)  # 10.0
            y0 = active_box.get('y0', y0)  # 0.0
            x1 = active_box.get('x1', x1)  # 100.0
            y1 = active_box.get('y1', y1)  # 90.0
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ base –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        base_x, base_y = 60.0, 40.0
        
    except Exception as e:
        # base_x –∏ base_y –æ—Å—Ç–∞—é—Ç—Å—è —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        pass
    
    # 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–≤–Ω–µ –±–ª–æ–∫–∞ try-except)
    dx, dy = 0.0, 0.0
    x_position = base_x + dx  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
    y_position = base_y + dy  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
    
    # 5. –ö–ª—ç–º–ø–∏–Ω–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    qr_size = 20.0
    x_position = max(x0, min(x_position, x1 - qr_size))  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
    y_position = max(y0, min(y_position, y1 - qr_size))  # ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç: x_position=60.0, y_position=40.0
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞**: ‚úÖ –£—Å–ø–µ—à–Ω–æ

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ **–û—à–∏–±–∫–∞ `cannot access local variable 'x0' where it is not associated with a value` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**

‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**

‚úÖ **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã** –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

‚úÖ **–§—É–Ω–∫—Ü–∏—è `_calculate_unified_qr_position` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π** —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã
- `backend/app/services/pdf_service.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_calculate_unified_qr_position`
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ `_calculate_unified_qr_position_legacy`

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
- `VARIABLE_SCOPE_FIX_REPORT.md` - –ø–µ—Ä–≤—ã–π –æ—Ç—á–µ—Ç
- `FINAL_VARIABLE_SCOPE_FIX_REPORT.md` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
- `COMPREHENSIVE_VARIABLE_SCOPE_FIX_REPORT.md` - –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ—Ç—á–µ—Ç

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
28 —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞

## –°—Ç–∞—Ç—É—Å
üü¢ **–ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê** - –û—à–∏–±–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–∏ –≤ –∫–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
