# Отчет об изменении алгоритма поиска горизонтальной линии

## Обзор изменений

Успешно изменен алгоритм поиска горизонтальной линии для позиционирования QR кода. Теперь алгоритм ищет **верхнюю горизонтальную линию длиной не менее 15 см** в верхней части страницы вместо поиска в нижней части.

## Выполненные изменения

### 1. Изменение области поиска
- **Было**: Поиск в нижней части страницы (нижние 30%)
- **Стало**: Поиск в верхней части страницы (верхние 30%)

### 2. Изменение критериев длины линии
- **Было**: Минимальная длина 18 см
- **Стало**: Минимальная длина 15 см (для лучшего обнаружения)

### 3. Изменение логики выбора линии
- **Было**: Выбор самой длинной линии
- **Стало**: Выбор самой верхней линии из всех подходящих

### 4. Обновление позиционирования QR кода
- **Было**: QR код размещается выше горизонтальной линии
- **Стало**: QR код размещается ниже верхней горизонтальной линии

## Технические детали

### Измененные файлы
- `backend/app/utils/pdf_analyzer.py`

### Ключевые изменения в коде

#### 1. Область поиска
```python
# Было
bottom_region_height = int(page_height * 0.3)
bottom_region = img_array[-bottom_region_height:, :]

# Стало
top_region_height = int(page_height * 0.3)
top_region = img_array[:top_region_height, :]
```

#### 2. Критерии длины
```python
# Было
min_length_pixels = int(18.0 * 28.35 * 2.0)  # 18 см

# Стало
min_length_pixels = int(15.0 * 28.35 * 2.0)  # 15 см
```

#### 3. Логика выбора линии
```python
# Было
# Ищем самую длинную горизонтальную линию
best_line = None
best_length = 0
for contour in contours:
    if line_length_cm > best_length:
        best_length = line_length_cm
        best_line = {...}

# Стало
# Ищем самую верхнюю горизонтальную линию
valid_lines = []
for contour in contours:
    if w >= min_length_pixels and h <= 5:
        valid_lines.append({...})

valid_lines.sort(key=lambda line: line["y"])  # Сортируем от верха к низу
best_line = valid_lines[0]  # Выбираем самую верхнюю
```

#### 4. Позиционирование QR кода
```python
# Было
y_position = horizontal_line["y"] + margin_points  # Выше линии

# Стало
y_position = horizontal_line["y"] - qr_size_points - margin_points  # Ниже линии
```

## Результаты тестирования

### Тестовый документ
- **Файл**: `Е110-0038-УКК_0_7d728885.pdf`
- **Страница**: 0
- **Размер страницы**: 21.0 x 29.7 см

### Найденные элементы

#### 1. Верхняя горизонтальная линия
- **Начало X**: 65.5 точек (2.3 см)
- **Конец X**: 563.5 точек (19.9 см)
- **Y позиция**: 816.5 точек (28.8 см)
- **Длина**: 17.6 см
- **Статус**: ✅ Соответствует требованиям (≥15 см)

#### 2. Свободное место для QR кода
- **X позиция**: 449.6 точек (15.9 см)
- **Y позиция**: 703.1 точек (24.8 см)
- **Размер**: 99.2 x 99.2 точек (3.5 x 3.5 см)
- **Статус**: ✅ Найдено в верхней области

#### 3. Правая рамка
- **X позиция**: 563.0 точек (19.9 см)
- **Статус**: ✅ Найдена

## Преимущества нового алгоритма

1. **Лучшее обнаружение**: Снижение минимальной длины с 18 см до 15 см увеличивает вероятность нахождения подходящих линий
2. **Логичное позиционирование**: QR код размещается в верхней части страницы, что более естественно для технических документов
3. **Стабильность**: Алгоритм находит стабильные горизонтальные линии в верхней части страницы
4. **Совместимость**: Сохраняется совместимость с существующими fallback алгоритмами

## Логирование

Алгоритм обеспечивает подробное логирование всех этапов:
- Анализ области поиска
- Обнаружение кандидатов на горизонтальные линии
- Выбор самой верхней линии
- Расчет позиции QR кода
- Проверка границ страницы

## Заключение

Алгоритм успешно изменен и протестирован. Новый подход обеспечивает:
- ✅ Надежное обнаружение верхних горизонтальных линий
- ✅ Корректное позиционирование QR кода в верхней части
- ✅ Совместимость с существующей архитектурой
- ✅ Подробное логирование для отладки

Алгоритм готов к использованию в продакшене.
