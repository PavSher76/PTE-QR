# 🔍 Диаграмма трейса вызова процедур расставления QR кода

## 📊 Общая схема процесса

```
┌─────────────────────────────────────────────────────────────────┐
│                    ЗАГРУЗКА PDF ДОКУМЕНТА                      │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              PDFService.add_qr_codes_to_pdf()                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. PdfReader(pdf_content)                               │   │
│  │ 2. PdfWriter()                                          │   │
│  │ 3. qr_codes_data_list = []                              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ЦИКЛ ПО СТРАНИЦАМ                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ for i, page in enumerate(reader.pages):                 │   │
│  │   page_number = i + 1                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                ОПРЕДЕЛЕНИЕ ОРИЕНТАЦИИ СТРАНИЦЫ                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ page_width = float(page.mediabox.width)                 │   │
│  │ page_height = float(page.mediabox.height)               │   │
│  │ is_landscape = page_width > page_height                 │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
            ┌─────────┴─────────┐
            │                   │
            ▼                   ▼
┌─────────────────┐   ┌─────────────────┐
│   PORTRAIT      │   │   LANDSCAPE     │
│   СТРАНИЦА      │   │   СТРАНИЦА      │
└─────────┬───────┘   └─────────┬───────┘
          │                     │
          ▼                     ▼
┌─────────────────┐   ┌─────────────────┐
│ 1. Логирование: │   │ 1. Создание     │
│    "Portrait    │   │    qr_data_     │
│    page         │   │    payload      │
│    detected"    │   │                 │
│                 │   │ 2. QRService.   │
│ 2. writer.      │   │    generate_    │
│    add_page(    │   │    qr_data_     │
│    page)        │   │    with_hmac()  │
│                 │   │                 │
│ 3. continue     │   │ 3. Добавление   │
│                 │   │    в qr_codes_  │
│                 │   │    data_list    │
└─────────────────┘   │                 │
                      │ 4. QRService.   │
                      │    generate_    │
                      │    qr_code_     │
                      │    image()      │
                      │                 │
                      │ 5. canvas.      │
                      │    Canvas()     │
                      │                 │
                      │ 6. Расчет       │
                      │    позиции      │
                      │                 │
                      │ 7. c.drawImage()│
                      │                 │
                      │ 8. c.save()     │
                      │                 │
                      │ 9. PdfReader    │
                      │    (QR PDF)     │
                      │                 │
                      │ 10. PdfMerger   │
                      │     .merge()    │
                      │                 │
                      │ 11. writer.     │
                      │     add_page()  │
                      └─────────────────┘
```

## 🔄 Детальный трейс для Landscape страницы

```
┌─────────────────────────────────────────────────────────────────┐
│                    LANDSCAPE СТРАНИЦА                           │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              СОЗДАНИЕ QR ДАННЫХ                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ qr_data_payload = {                                     │   │
│  │   "enovia_id": "TRACE-TEST",                            │   │
│  │   "revision": "1.0",                                    │   │
│  │   "page": 2                                             │   │
│  │ }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│         QRService.generate_qr_data_with_hmac()                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. Создание HMAC подписи                                │   │
│  │ 2. Генерация URL: /tmp/trace_output.pdf/TRACE-TEST/    │   │
│  │    1.0/2/c55735f951ad5698eff6f4cb96d5c047861b3341b19a  │   │
│  │    51f16df4e6d22614780f                                │   │
│  │ 3. Возврат (qr_data, hmac_signature)                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│        QRService.generate_qr_code_image()                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. Создание QR кода с данными                           │   │
│  │ 2. Размер: 99x99 пикселей (3.5 см)                      │   │
│  │ 3. Border: 4 пикселя                                     │   │
│  │ 4. Error correction: M                                   │   │
│  │ 5. Возврат PNG изображения                               │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                РАСЧЕТ ПОЗИЦИИ QR КОДА                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ page_width = 841.9 точек                                │   │
│  │ page_height = 595.3 точек                               │   │
│  │ qr_size_points = 99.225 точек                           │   │
│  │                                                         │   │
│  │ bottom_margin_cm = 9.5 см = 269.325 точек               │   │
│  │ right_margin_cm = 4.0 см = 113.4 точек                  │   │
│  │                                                         │   │
│  │ x_position = 841.9 - 113.4 - 99.225 = 629.275 точек     │   │
│  │ y_position = 595.3 - 269.325 - 99.225 = 226.75 точек    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              ОТРИСОВКА QR КОДА НА PDF                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. canvas.Canvas(qr_pdf_buffer, pagesize=letter)       │   │
│  │ 2. PIL.Image.open(BytesIO(qr_image_bytes))             │   │
│  │ 3. Сохранение во временный PNG файл                     │   │
│  │ 4. c.drawImage(temp_img.name, x_position, y_position,   │   │
│  │    width=qr_size_points, height=qr_size_points)        │   │
│  │ 5. c.save()                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              ОБЪЕДИНЕНИЕ СТРАНИЦ                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. PdfReader(qr_pdf_buffer) - чтение QR PDF            │   │
│  │ 2. Получение страницы с QR кодом                        │   │
│  │ 3. PdfMerger() - создание merger                        │   │
│  │ 4. merger.append(original_page) - добавление оригинала  │   │
│  │ 5. merger.append(qr_page) - добавление QR страницы      │   │
│  │ 6. merger.write(merged_buffer) - объединение            │   │
│  │ 7. Получение объединенной страницы                      │   │
│  │ 8. writer.add_page(merged_page) - добавление в PDF      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    СЛЕДУЮЩАЯ СТРАНИЦА                           │
└─────────────────────────────────────────────────────────────────┘
```

## 📋 Логика принятия решений

### 🔍 Определение ориентации страницы
```
if page_width > page_height:
    is_landscape = True
    # Обработка landscape страницы
else:
    is_landscape = False
    # Пропуск портретной страницы
```

### 📄 Обработка портретной страницы
```
if not is_landscape:
    logger.info("Portrait page detected - skipping QR code placement")
    writer.add_page(page)  # Добавить оригинальную страницу
    continue  # Перейти к следующей странице
```

### 🖼️ Обработка landscape страницы
```
if is_landscape:
    # 1. Создать QR данные
    qr_data, hmac = qr_service.generate_qr_data_with_hmac(...)
    
    # 2. Создать QR изображение
    qr_image = qr_service.generate_qr_code_image(qr_data)
    
    # 3. Рассчитать позицию
    x_pos = page_width - right_margin - qr_size
    y_pos = page_height - bottom_margin - qr_size
    
    # 4. Отрисовать QR код
    canvas.drawImage(qr_image, x_pos, y_pos, ...)
    
    # 5. Объединить страницы
    merger.merge(original_page, qr_page)
    
    # 6. Добавить в выходной PDF
    writer.add_page(merged_page)
```

## 🎯 Ключевые параметры

### 📐 Размеры и отступы
- **Размер QR кода**: 3.5 см × 3.5 см = 99.225 точек
- **Отступ от правого края**: 4.0 см = 113.4 точек
- **Отступ от нижнего края**: 9.5 см = 269.325 точек

### 📊 Формулы позиционирования
```
x_position = page_width - right_margin_points - qr_size_points
y_position = page_height - bottom_margin_points - qr_size_points
```

### 🔢 Пример расчета для A4 Landscape
```
page_width = 841.9 точек
page_height = 595.3 точек
qr_size = 99.225 точек
right_margin = 113.4 точек
bottom_margin = 269.325 точек

x_position = 841.9 - 113.4 - 99.225 = 629.275 точек
y_position = 595.3 - 269.325 - 99.225 = 226.75 точек
```

## ✅ Результат трейса

### 📊 Статистика обработки
- **Входной PDF**: 3 страницы (1 Portrait + 1 Landscape + 1 Portrait)
- **Выходной PDF**: 3 страницы
- **QR кодов создано**: 1 (только для Landscape страницы)
- **Портретные страницы**: пропущены (QR коды не добавлены)
- **Landscape страницы**: обработаны (QR коды добавлены)

### 🎯 Успешность выполнения
- ✅ **Портретные страницы**: корректно пропущены
- ✅ **Landscape страницы**: корректно обработаны
- ✅ **Позиционирование**: QR коды размещены в правильных координатах
- ✅ **Объединение страниц**: оригинальная страница + QR код
- ✅ **Выходной PDF**: содержит все страницы с правильным размещением QR кодов
