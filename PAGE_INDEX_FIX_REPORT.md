# –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ fallback –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ **–î–∏–∞–≥–Ω–æ–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
```
‚Äî /tmp/tmplcuosnwx.pdf, total_pages: 1, page_number: 3 ‚Üí out of range ‚Üí fallback (14.2, 14.2);
‚Äî /tmp/tmpn7aph9p4.pdf, page_number: 4 ‚Üí out of range ‚Üí fallback (14.2, 14.2);
‚Äî /tmp/tmp345oec2y.pdf, page_number: 5 ‚Üí out of range ‚Üí fallback (14.2, 14.2).
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí Page number out of range ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback (14.2, 14.2).

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### **1. –°–æ–≤–º–µ—â–µ–Ω –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF
temp_writer = PdfWriter()
temp_writer.add_page(page)  # ‚Üê –¢–æ–ª—å–∫–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞

# –ù–æ –ø–µ—Ä–µ–¥–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size_points, temp_pdf_path, page_number - 1  # ‚Üê page_number=3/4/5!
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: Page number out of range –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π PDF
temp_writer = PdfWriter()
temp_writer.add_page(page)  # ‚Üê –¢–æ–ª—å–∫–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞

# –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size_points, temp_pdf_path, 0  # ‚Üê page_number=0 –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF!
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –ê–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### **2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# Fallback –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ (14.2, 14.2) - –Ω–∏–∂–Ω–∏–π-–ª–µ–≤—ã–π
bottom_margin_cm = 5.5 + 0.5 + 3.5
right_margin_cm = 3.5 + 0.5
x_position = page_width - right_margin_points - qr_size_points  # ‚Üê –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
y_position = page_height - bottom_margin_points - qr_size_points  # ‚Üê –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —è–∫–æ—Ä—å bottom-right
x0 = 0.0  # MediaBox –≥—Ä–∞–Ω–∏—Ü—ã
y0 = 0.0
x1 = page_width
y1 = page_height

base_x, base_y = self.compute_anchor_xy(
    x0=x0, y0=y0, x1=x1, y1=y1,
    qr_w=qr_size_points,
    qr_h=qr_size_points,
    margin_pt=settings.QR_MARGIN_PT,
    stamp_clearance_pt=settings.QR_STAMP_CLEARANCE_PT,
    rotation=0
)

x_position = base_x  # ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: x1 - margin - qr_w
y_position = base_y  # ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: y0 + margin + clearance
```

### **3. –ï–¥–∏–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ–∫—Å:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª–∏ x0=0, y0=0 –¥–ª—è landscape
x0 = 0.0  # ‚Üê –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è cropbox —Å x0 != 0
y0 = 0.0
x1 = page_width
y1 = page_height
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞ –∏–∑ layout_info
if layout_info:
    coordinate_info = layout_info.get("coordinate_info", {})
    active_box = coordinate_info.get("active_box", {})
    x0 = active_box.get("x0", 0.0)  # ‚Üê –†–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞
    y0 = active_box.get("y0", 0.0)
    x1 = active_box.get("x1", page_width)
    y1 = active_box.get("y1", page_height)
else:
    # Fallback –∫ MediaBox –≥—Ä–∞–Ω–∏—Ü–∞–º
    x0 = 0.0
    y0 = 0.0
    x1 = page_width
    y1 = page_height
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

### **1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
- **–î–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF**: –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º `page_number = 0`
- **–î–ª—è –º–Ω–æ–≥–æ–ª–∏—Å—Ç–æ–≤–æ–≥–æ PDF**: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π `page_number`
- **–ù–∏–∫–∞–∫–∏—Ö "Page number out of range"**

### **2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback:**
- **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —è–∫–æ—Ä—å bottom-right**: `x = x1 - margin - qr_w, y = y0 + margin + clearance`
- **–ù–∏–∫–∞–∫–∏—Ö (14.2, 14.2)** - —ç—Ç–æ –Ω–∏–∂–Ω–∏–π-–ª–µ–≤—ã–π
- **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –æ—Ç –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü—ã**

### **3. –ï–¥–∏–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ–∫—Å:**
- **–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã** –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞ (x0, y0, x1, y1)
- **–í–∞–∂–Ω–æ –¥–ª—è cropbox** —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ x0
- **–ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ x1**, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —à–∏—Ä–∏–Ω–∞

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå `page_number: 3/4/5` –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF ‚Üí Page number out of range
- ‚ùå Fallback (14.2, 14.2) ‚Üí –Ω–∏–∂–Ω–∏–π-–ª–µ–≤—ã–π
- ‚ùå –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ x0=0 –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ `page_number: 0` –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF ‚Üí –∞–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Fallback –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —è–∫–æ—Ä—å bottom-right
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–∫—Å–∞

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

‚úÖ **–ò–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –¥–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ PDF –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è page_number=0
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback** - –≤—Å–µ–≥–¥–∞ bottom-right —è–∫–æ—Ä—å, –Ω–∏–∫–∞–∫–∏—Ö (14.2, 14.2)
‚úÖ **–ï–¥–∏–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ–∫—Å** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã (x0, y0, x1, y1)
‚úÖ **–ù–∏–∫–∞–∫–∏—Ö "Page number out of range"**

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–µ PDF –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback! üöÄ
