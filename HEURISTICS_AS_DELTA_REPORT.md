# –û—Ç—á–µ—Ç: –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ (–¥–µ–ª—å—Ç–∞)

## üéØ **–ó–∞–¥–∞—á–∞:**
"–î–∞–ª—å—à–µ –ª—é–±–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç pdf_analyzer —Ç—Ä–∞–∫—Ç—É–π—Ç–µ –∫–∞–∫ ¬´–∫–æ—Ä—Ä–µ–∫—Ü–∏—é¬ª, –∞ –Ω–µ –∫–∞–∫ –Ω–æ–≤—ã–π —è–∫–æ—Ä—å"

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

### **1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_calculate_landscape_qr_position`:**

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# Get detected positions using new algorithm
free_space = layout_info.get("free_space_3_5cm")
horizontal_line = layout_info.get("horizontal_line_18cm")
right_frame_edge = layout_info.get("right_frame_edge")

# Use new algorithm: search for free space 3.5x3.5 cm
if free_space:
    x_position = free_space["x"]  # ‚Üê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –ø–æ–ª–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!
    y_position = free_space["y"]  # ‚Üê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –ø–æ–ª–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!
    return x_position, y_position
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
# 1. –°–ù–ê–ß–ê–õ–ê –≤—ã—á–∏—Å–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å bottom-right
base_x, base_y = self.compute_anchor_xy(
    W=page_width,
    H=page_height,
    qr_w=qr_size,
    qr_h=qr_size,
    margin=settings.QR_MARGIN_PT,
    rotation=0,  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç 0¬∞ –¥–ª—è landscape
    anchor=settings.QR_ANCHOR
)

# 2. –ü–û–¢–û–ú –ø–æ–ª—É—á–∞–µ–º –¥–µ–ª—å—Ç—É –æ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫
dx, dy = self.pdf_analyzer.compute_heuristics_delta(pdf_path, page_number)

# 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–ª—å—Ç—É –∫ –±–∞–∑–æ–≤–æ–º—É —è–∫–æ—Ä—é
x_position = base_x + dx
y_position = base_y + dy

# 4. –ö–ª—ç–º–ø–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã
x_position = max(0, min(x_position, page_width - qr_size))
y_position = max(0, min(y_position, page_height - qr_size))
```

### **2. –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π fallback –∫–æ–¥:**

**–£–¥–∞–ª–µ–Ω–æ:**
- –°—Ç–∞—Ä—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã FALLBACK 1 –∏ FALLBACK 2
- –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ `detect_free_space_3_5cm` –∫–∞–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–∞–º–∫–∞–º –∏ –ª–∏–Ω–∏—è–º

**–ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞:**
- –ï–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫
- –ü—Ä–æ—Å—Ç–∞—è –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –ª–æ–≥–∏–∫–∞

### **3. –û–±–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è landscape:**
```python
debug_logger.info("üîç LANDSCAPE - Base anchor + heuristics delta", 
                page=page_number,
                box="media",
                W=page_width,
                H=page_height,
                rot=0,
                anchor=settings.QR_ANCHOR,
                qr=(qr_size, qr_size),
                margin=settings.QR_MARGIN_PT,
                base=(base_x, base_y),      # ‚Üê –ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
                delta=(dx, dy),             # ‚Üê –î–µ–ª—å—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫
                final=(x_position, y_position))  # ‚Üê –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

### **1. –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ:**
- **–í–°–ï** –º–µ—Ç–æ–¥—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É
- **–í–°–ï** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `pdf_analyzer` —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
- **–ù–ò –û–î–ò–ù** —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø–æ–ª–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

### **2. –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å:**
- –ë–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å –≤—Å–µ–≥–¥–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
- –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–∞–∫ –¥–µ–ª—å—Ç–∞
- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è = –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞ + –∫–ª—ç–º–ø

### **3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:**
- –ü—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å
- –î–µ–ª—å—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ ¬±50 pt
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- `_calculate_unified_qr_position`: ‚úÖ –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞
- `_calculate_landscape_qr_position`: ‚ùå –ø—Ä—è–º—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- `_calculate_unified_qr_position`: ‚úÖ –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞
- `_calculate_landscape_qr_position`: ‚úÖ –±–∞–∑–æ–≤—ã–π —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

‚úÖ **–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `pdf_analyzer` —Ç–µ–ø–µ—Ä—å —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏**
‚úÖ **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
‚úÖ **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: —è–∫–æ—Ä—å + –¥–µ–ª—å—Ç–∞ + –∫–ª—ç–º–ø**
‚úÖ **–£–¥–∞–ª–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π fallback –∫–æ–¥**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É "—ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏"! üöÄ
