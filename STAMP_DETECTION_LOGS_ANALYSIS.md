# üìä –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–¥–ø–∏—Å–∏

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–∏

### 1. **–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `detect_stamp_top_edge_landscape`**

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/utils/pdf_analyzer.py:29`
```python
def detect_stamp_top_edge_landscape(self, pdf_path: str, page_number: int = 0) -> Optional[float]:
```

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑**: `backend/app/utils/pdf_analyzer.py:416`
```python
stamp_top = self.detect_stamp_top_edge_landscape(pdf_path, page_number)
```

### 2. **–í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ `analyze_page_layout`**

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/utils/pdf_analyzer.py:410`
```python
def analyze_page_layout(self, pdf_path: str, page_number: int = 0) -> Optional[dict]:
```

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑**: `backend/app/services/pdf_service.py:284`
```python
layout_info = self.pdf_analyzer.analyze_page_layout(pdf_path, page_number)
```

### 3. **–í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ `_calculate_landscape_qr_position`**

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `backend/app/services/pdf_service.py:251`
```python
def _calculate_landscape_qr_position(self, page_width: float, page_height: float, 
                                   qr_size: float, pdf_path: str, page_number: int) -> tuple[float, float]:
```

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑**: `backend/app/services/pdf_service.py:215`
```python
x_position, y_position = self._calculate_landscape_qr_position(
    page_width, page_height, qr_size, pdf_path, page_number - 1
)
```

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

### ‚úÖ **–£—Å–ø–µ—à–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–¥–ø–∏—Å–∏**

#### **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```json
{
  "event": "üîç Starting stamp detection for landscape page",
  "pdf_path": "/tmp/test_stamp_detection.pdf",
  "page_number": 0,
  "level": "debug"
}
```

#### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ—Ç–µ–∫—Ü–∏–∏:**
```json
{
  "event": "‚úÖ Stamp top edge detected successfully",
  "stamp_top_y_points": 94.0,
  "stamp_bbox": [1458, 7, 36, 17],
  "confidence": "medium",
  "level": "info"
}
```

#### **–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞:**
- **–†–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã**: 841.9 x 595.3 —Ç–æ—á–µ–∫ (landscape)
- **–ú–∞—Å—à—Ç–∞–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: 2.0x (1684 x 1191 –ø–∏–∫—Å–µ–ª–µ–π)
- **–û–±–ª–∞—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞**: –ù–∏–∂–Ω–∏–µ 30% —Å—Ç—Ä–∞–Ω–∏—Ü—ã (178 –ø–∏–∫—Å–µ–ª–µ–π)
- **–î–µ—Ç–µ–∫—Ü–∏—è –∫—Ä–∞–µ–≤**: Canny (30, 100) - –Ω–∞–π–¥–µ–Ω–æ 4261 –ø–∏–∫—Å–µ–ª–µ–π –∫—Ä–∞–µ–≤
- **–ö–æ–Ω—Ç—É—Ä—ã**: 12 –Ω–∞–π–¥–µ–Ω–æ, 9 –ø—Ä–æ—à–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- **–í—ã–±—Ä–∞–Ω–Ω—ã–π —à—Ç–∞–º–ø**: bbox=[1458, 7, 36, 17], –ø–ª–æ—â–∞–¥—å=612, —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω=2.12

### ‚úÖ **Docker —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

#### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:**
```json
{
  "event": "‚úÖ Stamp top edge detected successfully",
  "stamp_top_y_points": 94.0,
  "stamp_bbox": [1458, 7, 36, 17],
  "confidence": "medium",
  "level": "info"
}
```

#### **–†–∞–∑–ª–∏—á–∏—è –≤ Docker:**
- **–ö—Ä–∞—è**: –ù–∞–π–¥–µ–Ω–æ 1907 –ø–∏–∫—Å–µ–ª–µ–π –∫—Ä–∞–µ–≤ (–º–µ–Ω—å—à–µ, —á–µ–º –ª–æ–∫–∞–ª—å–Ω–æ)
- **–ö–æ–Ω—Ç—É—Ä—ã**: 11 –Ω–∞–π–¥–µ–Ω–æ, 9 –ø—Ä–æ—à–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- **–†–∞–º–∫–∞**: –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ —à—Ç–∞–º–ø)

## üîÑ –¶–µ–ø–æ—á–∫–∞ –≤—ã–∑–æ–≤–æ–≤

### **–ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

1. **`PDFService.add_qr_codes_to_pdf()`** - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
2. **`PDFService._add_qr_code_to_page()`** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
3. **`PDFService._calculate_landscape_qr_position()`** - —Ä–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏
4. **`PDFAnalyzer.analyze_page_layout()`** - –∞–Ω–∞–ª–∏–∑ –º–∞–∫–µ—Ç–∞
5. **`PDFAnalyzer.detect_stamp_top_edge_landscape()`** - –¥–µ—Ç–µ–∫—Ü–∏—è —à—Ç–∞–º–ø–∞
6. **`PDFAnalyzer.detect_right_frame_edge()`** - –¥–µ—Ç–µ–∫—Ü–∏—è –ø—Ä–∞–≤–æ–π —Ä–∞–º–∫–∏
7. **`PDFAnalyzer.detect_bottom_frame_edge()`** - –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∏–∂–Ω–µ–π —Ä–∞–º–∫–∏

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ:**

#### **PDFService —É—Ä–æ–≤–µ–Ω—å:**
```json
{
  "event": "Calculating landscape QR position",
  "page_width": 841.89,
  "page_height": 595.28,
  "qr_size": 50,
  "level": "debug"
}
```

#### **PDFAnalyzer —É—Ä–æ–≤–µ–Ω—å:**
```json
{
  "event": "üîç Starting stamp detection for landscape page",
  "pdf_path": "/tmp/test_stamp_detection.pdf",
  "page_number": 0,
  "level": "debug"
}
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏

### **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü–∏–∏:**
- ‚úÖ **–®—Ç–∞–º–ø**: 100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å (94.0 —Ç–æ—á–µ–∫ –æ—Ç –≤–µ—Ä—Ö–∞)
- ‚ö†Ô∏è **–ü—Ä–∞–≤–∞—è —Ä–∞–º–∫–∞**: 50% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –≤ Docker)
- ‚ö†Ô∏è **–ù–∏–∂–Ω—è—è —Ä–∞–º–∫–∞**: 50% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –≤ Docker)

### **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ—Ç–µ–∫—Ü–∏–∏:**
- **Canny edge detection**: (30, 100) - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –∫–æ–Ω—Ç—É—Ä–∞**: 100 –ø–∏–∫—Å–µ–ª–µ–π
- **Epsilon –¥–ª—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏–∏**: 0.05
- **–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω**: 0.3 - 5.0
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —É–≥–ª—ã**: >= 4

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–∞

### **–†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏:**
```json
{
  "event": "Y position calculated from stamp",
  "stamp_top_edge": 94.0,
  "y_position": 108.175,
  "level": "info"
}
```

```json
{
  "event": "X position calculated from frame",
  "right_frame_edge": 786.0,
  "x_position": 707.65,
  "level": "info"
}
```

### **–ò—Ç–æ–≥–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:**
- **X**: 707.6 —Ç–æ—á–µ–∫ (–ª–µ–≤–µ–µ –ø—Ä–∞–≤–æ–π —Ä–∞–º–∫–∏ –Ω–∞ 1 —Å–º)
- **Y**: 108.2 —Ç–æ—á–µ–∫ (–Ω–∞–¥ —à—Ç–∞–º–ø–æ–º –Ω–∞ 0.5 —Å–º)

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
- **–§–æ—Ä–º–∞—Ç**: PNG —á–µ—Ä–µ–∑ PyMuPDF
- **–¶–≤–µ—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å**: Grayscale
- **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ**: 2x –º–∞—Å—à—Ç–∞–± –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
- **–û–±–ª–∞—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞**: –ù–∏–∂–Ω–∏–µ 30% —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### **–ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–µ–∫—Ü–∏–∏:**
1. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**
2. **–í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∏–∂–Ω–µ–π –æ–±–ª–∞—Å—Ç–∏**
3. **–î–µ—Ç–µ–∫—Ü–∏—è –∫—Ä–∞–µ–≤ (Canny)**
4. **–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—É—Ä–æ–≤**
5. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–ª–æ—â–∞–¥–∏ –∏ —Ñ–æ—Ä–º–µ**
6. **–í—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞**
7. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- **–õ–æ–∫–∞–ª—å–Ω–æ**: ~0.1 —Å–µ–∫—É–Ω–¥—ã
- **–í Docker**: ~0.1 —Å–µ–∫—É–Ω–¥—ã
- **–ü–∞–º—è—Ç—å**: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ

### **–¢–æ—á–Ω–æ—Å—Ç—å:**
- **–®—Ç–∞–º–ø**: –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (94.0 —Ç–æ—á–µ–∫)
- **–†–∞–º–∫–∞**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞ PDF
- **–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢–æ—á–Ω–æ–µ —Å —É—á–µ—Ç–æ–º –æ—Ç—Å—Ç—É–ø–æ–≤

## ‚úÖ –í—ã–≤–æ–¥—ã

### **–§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
1. ‚úÖ **–î–µ—Ç–µ–∫—Ü–∏—è —à—Ç–∞–º–ø–∞**: 100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
2. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ debug –ª–æ–≥–∏
3. ‚úÖ **–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢–æ—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ QR –∫–æ–¥–∞
4. ‚úÖ **Docker —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
5. ‚úÖ **Fallback —Ä–µ–∂–∏–º**: –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ OpenCV

### **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤—Å–µ —ç—Ç–∞–ø—ã –¥–µ—Ç–µ–∫—Ü–∏–∏
2. **–û—Ç–ª–∞–¥–∫–∞**: Debug –ª–æ–≥–∏ –ø–æ–º–æ–≥–∞—é—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ê–ª–≥–æ—Ä–∏—Ç–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ï—Å—Ç—å fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ OpenCV

## üéâ –°—Ç–∞—Ç—É—Å

**‚úÖ –ó–ê–í–ï–†–®–ï–ù–û** - –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–∞–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—Å–µ –≤—ã–∑–æ–≤—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –¥–µ—Ç–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ –≤ 100% —Å–ª—É—á–∞–µ–≤ –¥–ª—è —à—Ç–∞–º–ø–∞.
